sudo apt update && sudo apt install -y build-essential cmake git libusb-1.0-0-dev
======= MAKE THE DRIVER
git clone https://gitea.osmocom.org/sdr/rtl-sdr.git
cd rtl-sdr && mkdir build && cd build
cmake -DCMAKE_INSTALL_PREFIX=/usr -DINSTALL_UDEV_RULES=ON ..
make -j$(nproc)
sudo make install
sudo udevadm control --reload-rules && sudo udevadm trigger

======= MODPROBE RULES
echo "options usbcore autosuspend=-1" | sudo tee /etc/modprobe.d/usb-autosuspend.conf
echo "options dwc_otg autosuspend=-1" | sudo tee -a /etc/modprobe.d/usb-pi.conf
echo "options usbcore usbfs_memory_mb=1000" | sudo tee -a /etc/modprobe.d/usb-pi.conf

======= UDEV RULES
sudo vi /etc/udev/rules.d/85-usb-power.rules
  # Target the USB 2.0 root hub (primary controller for RTL-SDR)
  ACTION=="add", SUBSYSTEM=="usb", KERNEL=="usb1", ATTR{power/control}="on"
  
  # Target the USB 3.0 root hub (in case you ever use it)
  ACTION=="add", SUBSYSTEM=="usb", KERNEL=="usb2", ATTR{power/control}="on"
  
sudo vi /etc/udev/rules.d/85-rtl-sdr-power.rules  
  # Target the specific RTL-SDR device path
ACTION=="add", SUBSYSTEM=="usb", ATTR{idVendor}=="0bda", ATTR{idProduct}=="2838", \
  TEST=="power/control", ATTR{power/control}="on", \
  TEST=="power/autosuspend_delay_ms", ATTR{power/autosuspend_delay_ms}="-1"
    
sudo udevadm control --reload-rules  # probably not necessary because a reboot is coming
sudo udevadm trigger

======= DRIVER BLACKLIST
echo -e "blacklist dvb_usb_rtl28xxu\nblacklist rtl2832\nblacklist rtl2830" | sudo tee /etc/modprobe.d/rtl-sdr-blacklist.conf
echo "blacklist rtl2832_sdr" | sudo tee -a /etc/modprobe.d/rtl-sdr-blacklist.conf

======= USB POWER SERVICE
cat <<EOF | sudo tee /etc/systemd/system/usb-power.service
[Unit]
Description=USB Power Configuration
After=systemd-udevd.service

[Service]
Type=oneshot
ExecStart=/bin/sh -c "echo 1000 > /sys/module/usbcore/parameters/usbfs_memory_mb 2>/dev/null || true"
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now usb-power

====== FIRMWARE CMDLINE
sudo vi /boot/firmware/cmdline.txt
  append: dwc_otg.lpm_enable=0 usbhid.quirks=0x0bda:0x2838:0x40
  

====== TEST
reboot
cat /sys/bus/usb/devices/usb1/power/control  # should be "on"
grep . /etc/modprobe.d/usb-*.conf
grep . /etc/udev/rules.d/*.rules
cat /boot/firmware/cmdline.txt
systemctl is-enabled usb-power
systemctl is-active usb-power


Plug in the dongle 
lsusb                                       # should be in the list
lsmod | grep -E 'dvb_usb_rtl28xxu|rtl2832'  # should have no output
lsusb -t | grep -A 5 "Realtek"
dmesg | tail -n 30
zcat /proc/cmdline | grep -E 'lpm_enable|quirks'              # Should show: ... dwc_otg.lpm_enable=0 usbhid.quirks=0x0bda:0x2838:0x40
grep . /sys/bus/usb/devices/1-1.1.2/power/*
rtl_test -p


====== MAKE rtl_433
sudo apt install -y libtool libusb-1.0-0-dev librtlsdr-dev rtl-sdr cmake build-essential
git clone https://github.com/merbanan/rtl_433.git
cd rtl_433
mkdir build
cd build
cmake ..
make -j$(nproc)
sudo make install

====== TEST 
rtl_433 -S none
rtl_433 -f 433.92M -F json -C customary -v


=== OPTIONAL ===
For permanent weewx integration, create this optimized configuration file:

sudo mkdir -p /etc/rtl_433
sudo tee /etc/rtl_433/weather.conf <<'EOF'
# Focus only on weather sensors to reduce CPU usage
device_query = "Nooelec, NESDR SMArt v5"
freq = 433.92M
report_meta = 0
report_time = 0
quiet = 1
json_line = 1
output = http://localhost:8000/rtl433
EOF

sudo tee /etc/systemd/system/rtl_433.service <<'EOF'
[Unit]
Description=RTL_433 Weather Sensor Receiver
After=network.target

[Service]
ExecStart=/usr/local/bin/rtl_433 -C customary -F json -M protocol -M time:iso -M tags -c /etc/rtl_433/weather.conf
Restart=always
RestartSec=5
User=weewx

[Install]
WantedBy=multi-user.target
EOF


sudo systemctl enable rtl_433
sudo systemctl start rtl_433

systemctl status rtl_433
journalctl -u rtl_433 -f


=== WEEWX ===
sudo wget -O /tmp/weewx-key.asc https://weewx.com/keys.html
sudo gpg --dearmor -o /usr/share/keyrings/weewx-archive-keyring.gpg /tmp/weewx-key.asc
echo "deb [signed-by=/usr/share/keyrings/weewx-archive-keyring.gpg] https://weewx.com/apt bookworm stable" | sudo tee /etc/apt/sources.list.d/weewx.list
sudo apt update
sudo apt install -y weewx
sudo wee_extension --install=https://github.com/matthewwall/weewx-rtl_433/releases/latest/download/weewx-rtl_433.zip



====== Static IP
sudo nmcli connection modify preconfigured ipv4.method manual ipv4.addresses 192.168.1.14/24 ipv4.gateway 192.168.1.1 ipv4.dns "192.168.1.1 8.8.8.8"
nmcli | grep inet4
nmcli connection show preconfigured | grep ipv4.method
















